
@{
    ViewBag.Title = "Manage";
}

<h2>Manage</h2>
<div ng-app="manageApp" class="container">
    <div ng-controller="manageController">
        <div class="jumbotron">
            <h1>Import WSDL</h1>
            <p>Enter WSDL URL:</p>
            <form role="form">
                <input type="text" ng-model="wsdlUrl" placeholder="Enter WSDL URL here" /> <button ng-click="readWsdl()">Load WSDL</button>
            </form>
        </div>

        <form role="form">
            <div ng-repeat="mapping in mappings">
                <div class="row">
                    <label class="col-md-2">Method</label>
                    <label class="col-md-8">RouteTemplate</label>
                </div>
                <div class="row">
                    <div class="col-md-2">
                        <input type="text" class="form-control" ng-model="mapping.method" />
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" ng-model="mapping.routeTemplate" />
                    </div>
                </div>
                <div class="row">
                    <label class="col-md-4">SOAP URL</label>
                    <label class="col-md-4">SOAP Action</label>
                    <label class="col-md-4">SOAP Content-Type</label>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" ng-model="mapping.soapUrl"/>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" ng-model="mapping.soapAction " />
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" ng-model="mapping.contentType" />
                    </div>
                </div>
                <div class="row">
                    <label class="col-md-12">SOAP BODY</label>
                </div>
                <div class="row">
                    <div class="col">
                        <textarea class="form-control" rows="4" ng-model="mapping.soapBody"></textarea>
                    </div>
                </div>
                <p>&nbsp;</p>
            </div>
        </form>

        <div>
            <button ng-click="newMap()">Add new map</button>
            <button ng-click="saveMappings()" class="btn-primary">Save changes</button>
        </div>

        <!-- loading frame-->
        <div style="position:fixed;top:0px;left:0px; width:100%;height:100%;background-color:rgba(50,50,50,0.3)" ng-show="loading">
        </div>
    </div>  
</div>
<script src="~/Scripts/angular.js"></script>
<script>
    // TODO - P2 - get angular bundle working.
    // TODO - P2 - not an inline script, yuk.
    // TODO - P2 - not inline styles too! yuk, yuk!
    var manageApp = angular.module('manageApp', []);
    manageApp.controller('manageController', function ($scope, $http) {

        // initial state
        $scope.loading = true;
        $scope.wsdlUrl = "";

        $http({ method: 'GET', url: '/map' }).
            success(function (data, status, headers, config) {
                //$scope.mappings = data;
                $scope.loading = false;
            }).
            error(function (data, status, headers, config) {
                alert(data);
                debugger;
            });

        // actions
        $scope.readWsdl = function () {
            $scope.loading = true;
            $http({
                method: 'POST',
                url: '/map',
                data: { url: $scope.wsdlUrl }
            }).
                success(function (data, status, headers, config) {
                    document.location.reload();
                    $scope.loading = false;
                }).
                error(function (data, status, headers, config) {
                    alert(data);
                    debugger;
                    $scope.loading = false;
                });
            
        }

        $scope.newMap = function () {
            $scope.mappings.push({});
        }

        $scope.saveMappings = function () {
            $scope.loading = true;
            $http({ method: 'PUT', url: '/map', data: $scope.mappings }).
            success(function (data, status, headers, config) {
                alert('Saved (in memory, for now)')
                $scope.loading = false;
            }).
           error(function (data, status, headers, config) {
               alert(data);
               debugger;
           });
        }
    });

</script>
